<%- include('./includes/header.ejs') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="men_banner">
  <%- include('./includes/headerNav.ejs', { cartItemsLength: cart && cart.items ? cart.items.length : 0 }) %>
  <section class="h-100 gradient-custom">
    <div class="container py-5 h-100">
      <div class="row d-flex justify-content-center align-items-center h-100">
        <div class="col-lg-10 col-xl-8">
          <div class="card" style="border-radius: 10px;">
            <div class="card-header px-4 py-5">
              <h5 class="text-muted mb-0">Thanks for your Order, <span style="color: grey;"><%= user.fname %></span> !</h5>
            </div>

            <% order.items.forEach(item => { %>
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <!-- <p class="lead fw-normal mb-0" style="color: grey;">Receipt</p> -->
                <!-- <p class="small text-muted mb-0">Order Id : 1KAU9-84UIL</p> -->
              </div>
              <div class="card shadow-0 border mb-4">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-2">
                      <img src="/<%= item.product.imageURLs[3] %>" class="img-fluid" alt="<%= item.product.imageURLs[3] %>">
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0"><%= item.product.title %></p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small"><%= item.product.category.name %></p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small"><%= item.product.description %></p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small">Qty: <%= item.quantity %></p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <% if (item.product.offer && item.product.offer.percentage) { %>
                      <% const discountedPrice = item.product.price - (item.product.price * (item.product.offer.percentage / 100)); %>
                      <%= discountedPrice %>
                      <% } else if (item.product.category && item.product.category.offer ) { %>
                      <% const discountedPrice = item.product.price - (item.product.price * (item.product.category.offer.percentage / 100)); %>
                      <%= discountedPrice %>
                      <% } else { %>
                      <p class="text-muted mb-0 small">₹<%= item.product.price %></p>
                      <% } %>
                    </div>
                  </div>
                  <hr class="mb-4" style="background-color: #e0e0e0; opacity: 1;">
                  <div class="row d-flex align-items-center">
                    <div class="col-md-2">
                      <!-- <p class="text-muted mb-0 small">Track Order</p> -->
                      <!-- <a href="/cancel-order/<%= item._id %>" class="btn btn-s btn-danger">Cancel</a><br><br> -->
                    </div>
                    <!-- <div class="col-md-10">
                      <div class="progress" style="height: 6px; border-radius: 16px;">
                        <div class="progress-bar" role="progressbar" style="width: 65%; border-radius: 16px; background-color: grey;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <div class="d-flex justify-content-around mb-1">
                        <p class="text-muted mt-1 mb-0 small ms-xl-5">Out for delivary</p>
                        <p class="text-muted mt-1 mb-0 small ms-xl-5">Delivered</p>
                      </div>
                    </div> -->
                  </div>
                </div>
              </div>
              <% }) %>

              <!-- <div class="card shadow-0 border mb-4">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-2">
                      <img src="https://mdbcdn.b-cdn.net/img/Photos/Horizontal/E-commerce/Products/1.webp"
                        class="img-fluid" alt="Phone">
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0">iPad</p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small">Pink rose</p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small">Capacity: 32GB</p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small">Qty: 1</p>
                    </div>
                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                      <p class="text-muted mb-0 small">$399</p>
                    </div>
                  </div>
                  <hr class="mb-4" style="background-color: #e0e0e0; opacity: 1;">
                  <div class="row d-flex align-items-center">
                    <div class="col-md-2">
                      <p class="text-muted mb-0 small">Track Order</p>
                    </div>
                    <div class="col-md-10">
                      <div class="progress" style="height: 6px; border-radius: 16px;">
                        <div class="progress-bar" role="progressbar"
                          style="width: 20%; border-radius: 16px; background-color: grey;" aria-valuenow="20"
                          aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <div class="d-flex justify-content-around mb-1">
                        <p class="text-muted mt-1 mb-0 small ms-xl-5">Out for delivary</p>
                        <p class="text-muted mt-1 mb-0 small ms-xl-5">Delivered</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div> -->

              <div class="d-flex justify-content-between pt-2">
              <a href="/generateInvoice/<%= order._id %>" id="downloadInvoiceButton" >Download Invoice</a>

                <!-- <p class="fw-bold mb-0">Order Details</p> -->
                <p class="text-muted mb-0"><span class="fw-bold me-4">Total</span>₹ <%= order.totalAmount %></p>
              </div>

              <div class="d-flex justify-content-between pt-2">
                <p class="text-muted mb-0">Order Id : <%= order._id %></p>
                <!-- <p class="text-muted mb-0"><span class="fw-bold me-4">Discount</span> $19.00</p> -->
                <p class="text-muted mb-0 " style="font-weight: bold;">Status : <%= order.status %></p>

              </div>
              <div class="d-flex justify-content-between pt-2">
                <p class="text-muted mb-0">Payment mode : <%= order.paymentMethod %></p>
                <!-- <p class="text-muted mb-0"><span class="fw-bold me-4">Discount</span> $19.00</p> -->
              </div>

              <div class="d-flex justify-content-between">
                <p class="text-muted mb-0">Date : <%= order.createdAt %></p>
                <!-- <p class="text-muted mb-0"><span class="fw-bold me-4">GST 18%</span> 123</p> -->
              </div>

              <div class="d-flex justify-content-between mb-5">
                <p class="text-muted mb-0">Address : <%= order.selectedAddress %></p>
                <div class="col-md-2">
                  <% if (order.status !== 'Delivered' && order.status !== 'Pending') { %>
                  <a href="" class="btn btn-sm btn-danger" onclick="cancelOrder(event,'<%= order._id %>')">Cancel Order</a><br><br>
                  <% } else if (order.status === 'Pending') { %>
                  <a href="" class="btn btn-sm btn-success" onclick="cancelReturn(event,'<%= order._id %>')">Cancel Return</a><br><br>
                  <% } else { %>
                  <a href="" class="btn btn-sm btn-danger" onclick="returnOrder(event,'<%= order._id %>')">Return Order</a><br><br>
                  <% } %>

                </div>
                <!-- <p class="text-muted mb-0"><span class="fw-bold me-4">Delivery Charges</span> Free</p> -->
              </div>
              <div class="d-flex justify-content-between mb-5">
                <!-- <p class="text-muted mb-0"><span class="fw-bold me-4">Delivery Charges</span> Free</p> -->

              </div>

            </div>
            <!-- <div class="card-footer border-0 px-4 py-5" style="background-color: grey; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
              <h5 class="d-flex align-items-center justify-content-end text-white text-uppercase mb-0">Total
                paid: <span class="h2 mb-0 ms-2">$1040</span></h5>
            </div> -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    async function cancelOrder(event, orderId) {
      event.preventDefault();
      Swal.fire({
        title: "Cancel this order?",
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes"
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await $.ajax({
              type: 'POST',
              data: {
                orderId: orderId
              },
              url: '/cancel-order',
            });

            if (response.success) {
              Swal.fire({
                title: "",
                text: "Order canceled",
                icon: "success",
                showConfirmButton: false, // Hide the "OK" button
              });

              // Optionally, you can refresh the page
              setTimeout(() => {
                // Redirect to the /my-orders route after the delay
                window.location.href = '/my-orders';
              }, 2000);
            }
          } catch (error) {
            console.error(error);
          }
        }
      });

    }
    async function returnOrder(event, orderId) {
      event.preventDefault();
      console.log('ordrer id from script ', orderId);
      Swal.fire({
        title: "Are you sure?",
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes"
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await $.ajax({
              type: 'POST',
              data: {
                orderId: orderId
              },
              url: '/return-order',
            });

            if (response.success) {
              Swal.fire({
                title: "",
                text: "Return request has been sent",
                icon: "success",
                showConfirmButton: false, // Hide the "OK" button
              });

              // Optionally, you can refresh the page
              setTimeout(() => {
                // Redirect to the /my-orders route after the delay
                window.location.href = '/my-orders';
              }, 2000);
            }
          } catch (error) {
            console.error(error);
          }
        }
      });

    }
    async function cancelReturn(event, orderId) {
      event.preventDefault();
      try {
        const response = await $.ajax({
          type: 'POST',
          data: {
            orderId: orderId
          },
          url: '/cancel-return',
        });

        if (response.success) {
          Swal.fire({
            title: "",
            text: "Return canceled ",
            icon: "success",
            showConfirmButton: false, // Hide the "OK" button
          });

          // Optionally, you can refresh the page
          setTimeout(() => {
            // Redirect to the /my-orders route after the delay
            window.location.href = '/my-orders';
          }, 2000);
        }
      } catch (error) {
        console.error(error);
      }
    }
  </script>


  </body>

  </html>